<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Therac-25 Simulator - Educational</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Courier New', monospace;
            background: #0a0a0a;
            color: #00ff00;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .warning {
            background: #ff0000;
            color: #ffffff;
            padding: 20px;
            margin-bottom: 20px;
            border: 3px solid #ffffff;
            text-align: center;
            font-weight: bold;
        }

        .warning h1 {
            margin-bottom: 10px;
            font-size: 24px;
        }

        .warning p {
            margin: 5px 0;
            font-size: 14px;
        }

        .main-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .panel {
            background: #1a1a1a;
            border: 2px solid #00ff00;
            padding: 15px;
        }

        .panel h2 {
            color: #00ffff;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #00ff00;
        }

        .status-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 15px;
        }

        .status-item {
            padding: 10px;
            background: #0f0f0f;
            border: 1px solid #333;
        }

        .status-label {
            color: #888;
            font-size: 12px;
            margin-bottom: 5px;
        }

        .status-value {
            font-size: 18px;
            font-weight: bold;
        }

        .safe {
            color: #00ff00;
        }

        .unsafe {
            color: #ff0000;
            animation: blink 1s infinite;
        }

        @keyframes blink {
            50% { opacity: 0.5; }
        }

        .meos-config {
            margin-bottom: 20px;
        }

        .meos-item {
            margin: 10px 0;
            padding: 10px;
            background: #0f0f0f;
            border-left: 3px solid #00ff00;
        }

        .controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }

        button {
            background: #003300;
            color: #00ff00;
            border: 2px solid #00ff00;
            padding: 12px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
        }

        button:hover {
            background: #00ff00;
            color: #000000;
        }

        button:active {
            transform: scale(0.95);
        }

        button.danger {
            background: #330000;
            border-color: #ff0000;
            color: #ff0000;
        }

        button.danger:hover {
            background: #ff0000;
            color: #ffffff;
        }

        button.primary {
            background: #000033;
            border-color: #00ffff;
            color: #00ffff;
        }

        button.primary:hover {
            background: #00ffff;
            color: #000000;
        }

        .gauge {
            height: 40px;
            background: #0f0f0f;
            border: 2px solid #00ff00;
            position: relative;
            margin: 10px 0;
        }

        .gauge-fill {
            height: 100%;
            background: linear-gradient(90deg, #00ff00, #ffff00, #ff0000);
            transition: width 0.3s;
        }

        .gauge-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-weight: bold;
            text-shadow: 0 0 5px #000;
        }

        .log {
            background: #0a0a0a;
            border: 2px solid #00ff00;
            padding: 15px;
            height: 300px;
            overflow-y: auto;
            font-size: 12px;
        }

        .log-entry {
            margin: 5px 0;
            padding: 5px;
            border-left: 2px solid #333;
            padding-left: 10px;
        }

        .log-entry.error {
            color: #ff0000;
            border-left-color: #ff0000;
            font-weight: bold;
        }

        .log-entry.success {
            color: #00ff00;
            border-left-color: #00ff00;
        }

        .phase-indicator {
            padding: 10px;
            text-align: center;
            font-size: 20px;
            font-weight: bold;
            margin: 10px 0;
            border: 2px solid;
        }

        .phase-reset { background: #222; border-color: #666; color: #666; }
        .phase-dataentry { background: #332200; border-color: #ffff00; color: #ffff00; }
        .phase-treatment { background: #003300; border-color: #00ff00; color: #00ff00; }
        .phase-pause { background: #330000; border-color: #ff0000; color: #ff0000; }
        .phase-terminate { background: #330033; border-color: #ff00ff; color: #ff00ff; }

        .malfunction-alert {
            background: #ff0000;
            color: #ffffff;
            padding: 15px;
            margin: 10px 0;
            border: 3px solid #ffffff;
            font-weight: bold;
            animation: blink 0.5s infinite;
        }

        select {
            background: #0f0f0f;
            color: #00ff00;
            border: 2px solid #00ff00;
            padding: 8px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            width: 100%;
        }

        .input-group {
            margin: 10px 0;
        }

        .input-group label {
            display: block;
            color: #888;
            margin-bottom: 5px;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="warning">
            <h1>‚ö†Ô∏è THERAC-25 SIMULATOR - EDUCATIONAL WARNING ‚ö†Ô∏è</h1>
            <p>This simulator recreates SOFTWARE BUGS that caused REAL DEATHS in the 1980s.</p>
            <p>Based on Nancy Leveson's analysis: "Medical Devices: The Therac-25"</p>
            <p>FOR EDUCATIONAL PURPOSES ONLY - Demonstrates race conditions and safety-critical system failures</p>
        </div>

        <div class="main-grid">
            <!-- Left Panel: Status and Console -->
            <div>
                <div class="panel">
                    <h2>System Status</h2>
                    <div id="phase-indicator" class="phase-indicator phase-reset">RESET</div>

                    <div class="status-grid">
                        <div class="status-item">
                            <div class="status-label">Safety Status</div>
                            <div id="safety-status" class="status-value safe">SAFE</div>
                        </div>
                        <div class="status-item">
                            <div class="status-label">Malfunctions</div>
                            <div id="malfunction-count" class="status-value">0</div>
                        </div>
                    </div>

                    <div id="malfunction-alert"></div>

                    <div class="status-label">Dose Progress</div>
                    <div class="gauge">
                        <div id="dose-gauge" class="gauge-fill" style="width: 0%"></div>
                        <div id="dose-text" class="gauge-text">0.0 / 200.0 cGy (0%)</div>
                    </div>
                </div>

                <div class="panel" style="margin-top: 20px;">
                    <h2>Console Parameters (Operator Input)</h2>
                    <div class="meos-config">
                        <div class="input-group">
                            <label>Beam Type</label>
                            <select id="beam-type">
                                <option value="0">X-Ray (requires flatness filter)</option>
                                <option value="1">Electron (direct beam)</option>
                            </select>
                        </div>
                        <div class="input-group">
                            <label>Beam Energy</label>
                            <select id="beam-energy">
                                <option value="0">5 MeV</option>
                                <option value="1" selected>10 MeV</option>
                                <option value="2">15 MeV</option>
                                <option value="3">20 MeV</option>
                                <option value="4">25 MeV</option>
                            </select>
                        </div>
                    </div>
                    <div id="console-meos"></div>
                </div>
            </div>

            <!-- Right Panel: Hardware and Controls -->
            <div>
                <div class="panel">
                    <h2>Hardware State (Actual)</h2>
                    <div id="hardware-meos"></div>
                </div>

                <div class="panel" style="margin-top: 20px;">
                    <h2>Controls</h2>
                    <div class="controls">
                        <button onclick="resetSystem()">üîÑ Reset</button>
                        <button onclick="completeDataEntry()" class="primary">‚úì Complete Data Entry</button>
                        <button onclick="startTreatment()" class="primary">‚ñ∂ Start Treatment</button>
                        <button onclick="stopTreatment()" class="danger">‚è∏ Pause Treatment</button>
                        <button onclick="resumeTreatment()">‚ñ∂ Resume Treatment</button>
                        <button onclick="generateRandom()">üé≤ Random Safe Params</button>
                        <button onclick="generateRaceCondition()" class="danger">üíÄ Trigger Race Bug</button>
                        <button onclick="toggleCollimator()" class="danger">‚ö†Ô∏è Toggle Collimator</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="panel">
            <h2>Event Log</h2>
            <div id="log" class="log"></div>
        </div>
    </div>

    <script type="module">
        import init, { WasmTherac25 } from './pkg/rstherac25.js';

        let simulator;

        async function run() {
            await init();
            window.simulator = simulator = new WasmTherac25();

            // Set up event listeners
            document.getElementById('beam-type').addEventListener('change', (e) => {
                simulator.setBeamType(parseInt(e.target.value));
            });

            document.getElementById('beam-energy').addEventListener('change', (e) => {
                simulator.setBeamEnergy(parseInt(e.target.value));
            });

            // Start update loop
            setInterval(updateUI, 100);
        }

        function updateUI() {
            if (!simulator) return;

            const state = simulator.getState();

            // Update phase
            const phaseEl = document.getElementById('phase-indicator');
            phaseEl.textContent = simulator.getPhase();
            phaseEl.className = 'phase-indicator phase-' + simulator.getPhase().toLowerCase().replace(/\s+/g, '');

            // Update safety status
            const safe = simulator.isSafe();
            const safetyEl = document.getElementById('safety-status');
            safetyEl.textContent = safe ? 'SAFE' : 'UNSAFE!';
            safetyEl.className = 'status-value ' + (safe ? 'safe' : 'unsafe');

            // Update malfunction count
            document.getElementById('malfunction-count').textContent = simulator.getMalfunctionCount();

            // Update malfunction alert
            const malfunction = simulator.getLastMalfunction();
            const malfunctionEl = document.getElementById('malfunction-alert');
            if (malfunction) {
                malfunctionEl.innerHTML = `<div class="malfunction-alert">${malfunction}</div>`;
            } else {
                malfunctionEl.innerHTML = '';
            }

            // Update dose gauge
            const delivered = simulator.getDoseDelivered();
            const target = simulator.getDoseTarget();
            const percent = target > 0 ? Math.min((delivered / target) * 100, 100) : 0;
            document.getElementById('dose-gauge').style.width = percent + '%';
            document.getElementById('dose-text').textContent =
                `${delivered.toFixed(1)} / ${target.toFixed(1)} cGy (${percent.toFixed(1)}%)`;

            // Update MEOS displays
            if (state) {
                updateMeosDisplay('console-meos', state.console_meos);
                updateMeosDisplay('hardware-meos', state.hardware_meos);
            }

            // Update log
            const logs = simulator.getLog();
            const logEl = document.getElementById('log');
            logEl.innerHTML = logs.map(log => {
                const isError = log.includes('MALFUNCTION') || log.includes('CRITICAL');
                const isSuccess = log.includes('complete') || log.includes('reached');
                const className = isError ? 'error' : (isSuccess ? 'success' : '');
                return `<div class="log-entry ${className}">${log}</div>`;
            }).join('');
            logEl.scrollTop = logEl.scrollHeight;
        }

        function updateMeosDisplay(id, meos) {
            const el = document.getElementById(id);
            const beamTypeStr = meos.beam_type === 'XRay' ? 'X-Ray' :
                               meos.beam_type === 'Electron' ? 'Electron' : 'Undefined';
            const energyStr = meos.beam_energy.replace('E', '') + ' MeV';
            const collimatorStr = meos.collimator === 'InPosition' ? 'In Position (Filter)' :
                                 meos.collimator === 'OutOfPosition' ? 'Out of Position' : 'Transitioning...';

            el.innerHTML = `
                <div class="meos-item">Beam Type: <strong>${beamTypeStr}</strong></div>
                <div class="meos-item">Energy: <strong>${energyStr}</strong></div>
                <div class="meos-item">Collimator: <strong>${collimatorStr}</strong></div>
            `;
        }

        // Global functions for buttons
        window.resetSystem = () => simulator.reset();
        window.completeDataEntry = () => simulator.completeDataEntry();
        window.startTreatment = () => simulator.startTreatment();
        window.stopTreatment = () => simulator.stopTreatment();
        window.resumeTreatment = () => simulator.resumeTreatment();
        window.generateRandom = () => simulator.generateRandomParameters();
        window.generateRaceCondition = () => simulator.generateRaceConditionParameters();
        window.toggleCollimator = () => simulator.toggleCollimator();

        run();
    </script>
</body>
</html>
